<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Host</title>
    <style>
      :root{
        --bg:#0b0b0f;
        --card:#11111a;
        --stroke:#232338;
        --muted:rgba(255,255,255,.72);
        --muted2:rgba(255,255,255,.55);
        --accent:#ff2b5d;
        --accent2:#f4b70c;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        background: radial-gradient(1200px 600px at 50% -20%, rgba(255,43,93,.25), transparent 60%),
                    radial-gradient(900px 500px at 110% 20%, rgba(244,183,12,.16), transparent 60%),
                    var(--bg);
        color:#fff;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom);
      }
      .wrap{
        height:100%;
        max-width: 980px;
        margin: 0 auto;
        display:flex;
        flex-direction:column;
        gap:12px;
      }

      .grid{
        flex:1;
        display:grid;
        grid-template-columns: 1fr;
        gap:12px;
        min-height: 0;
      }
      @media (min-width: 900px){
        .grid{
          grid-template-columns: 1.2fr .8fr;
        }
      }

      .card{
        background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
        border: 1px solid var(--stroke);
        border-radius: 18px;
        padding: 14px;
        backdrop-filter: blur(10px);
        box-shadow: 0 18px 60px rgba(0,0,0,.55);
        min-height: 0;
      }

      .top{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-bottom: 10px;
      }
      .title{
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .title h2{
        margin:0;
        font-size: 18px;
      }
      .meta{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        font-size: 13px;
        color: var(--muted);
      }
      .pill{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(0,0,0,.18);
      }

      button{
        padding: 12px 14px;
        border-radius: 999px;
        border: 0;
        background: var(--accent);
        color:#fff;
        font-weight: 900;
        cursor:pointer;
      }
      button:disabled{ opacity:.5; cursor:not-allowed; }

      .row{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        margin-top: 10px;
      }
      .btn{
        background: rgba(255,255,255,.06);
        border: 1px solid rgba(255,255,255,.10);
      }
      .btn.primary{
        background: linear-gradient(180deg, rgba(255,43,93,.95), rgba(255,43,93,.75));
        border: none;
      }
      .btn.warn{
        background: rgba(255,255,255,.06);
        border: 1px solid rgba(255,255,255,.10);
      }

      .slider{ margin-top: 12px; text-align:left; }
      .slider small{ color: var(--muted2); }
      .slider input{ width:100%; }

      .status{
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted2);
      }

      /* CHAT */
      .chat{
        display:flex;
        flex-direction:column;
        min-height: 0;
      }
      .chatHead{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-bottom:10px;
      }
      .chatHead .h{
        font-weight: 900;
        font-size: 14px;
      }
      .messages{
        flex:1;
        overflow:auto;
        padding: 10px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(0,0,0,.22);
        min-height: 220px;
      }
      .msg{
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,.08);
        background: rgba(255,255,255,.04);
        margin-bottom: 10px;
      }
      .msg .u{
        font-size: 12px;
        font-weight: 900;
        opacity: .9;
        margin-bottom: 4px;
      }
      .msg .t{
        font-size: 14px;
        opacity: .9;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .composer{
        margin-top: 10px;
        display:flex;
        gap:10px;
        align-items:center;
      }
      .input{
        flex:1;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(0,0,0,.22);
        color:#fff;
        font-size: 15px;
        outline:none;
      }
      .send{
        width: 52px;
        height: 44px;
        border-radius: 14px;
        border: none;
        background: linear-gradient(180deg, rgba(244,183,12,.95), rgba(244,183,12,.75));
        font-weight: 900;
        cursor:pointer;
      }

      audio{ display:none; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="grid">
        <!-- LEFT: CONTROLES -->
        <div class="card">
          <div class="top">
            <div class="title">
              <h2>üéôÔ∏è Host (micro + m√∫sica)</h2>
              <div class="meta">
                <span class="pill">Room: <b id="roomName"></b></span>
                <span class="pill">Conectados: <b id="connectedCount">0</b></span>
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="startBtn">Empezar a transmitir</button>

            <input id="fileInput" type="file" accept="audio/mpeg,audio/mp3,.mp3" style="display:none" />
            <button class="btn" id="pickBtn" disabled>üìÅ Elegir MP3</button>
            <button class="btn" id="uploadBtn" disabled>‚¨Ü Subir</button>

            <button class="btn" id="songBtn" disabled>‚ñ∂ Reproducir</button>
            <button class="btn warn" id="stopSongBtn" disabled>‚è∏ Pausar</button>
          </div>

          <div class="slider">
            <small>Volumen m√∫sica</small>
            <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.7" disabled />
          </div>

          <div class="status" id="status">Listo.</div>

          <audio id="song" preload="auto" playsinline></audio>
        </div>

        <!-- RIGHT: CHAT -->
        <div class="card chat">
          <div class="chatHead">
            <div class="h">üí¨ Chat en vivo</div>
            <small style="color: var(--muted2);">Lo ven todos en la sala</small>
          </div>

          <div class="messages" id="messages"></div>

          <div class="composer">
            <input class="input" id="msgInput" type="text" maxlength="300" placeholder="Escribe algo como host‚Ä¶" />
            <button class="send" id="sendBtn" title="Enviar">‚û§</button>
          </div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const params = new URLSearchParams(location.search);
      const room = params.get("room") || "canal1";
      document.getElementById("roomName").textContent = room;

      const socket = io();
      const peers = new Map();

      const startBtn = document.getElementById("startBtn");
      const pickBtn = document.getElementById("pickBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("fileInput");

      const songBtn = document.getElementById("songBtn");
      const stopSongBtn = document.getElementById("stopSongBtn");
      const songEl = document.getElementById("song");

      const musicVol = document.getElementById("musicVol");
      const connectedCountEl = document.getElementById("connectedCount");

      // CHAT
      const messagesEl = document.getElementById("messages");
      const msgInput = document.getElementById("msgInput");
      const sendBtn = document.getElementById("sendBtn");

      const pcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

      let mixedStream = null;
      let audioCtx = null;
      let micSource = null;
      let songSource = null;
      let destination = null;
      let musicGain = null;
      let selectedFile = null;

      function setStatus(msg) {
        document.getElementById("status").textContent = msg;
      }

      // ====== CHAT UI ======
      function addMessage({ user = "Usuario", text = "" }) {
        const wrap = document.createElement("div");
        wrap.className = "msg";

        const u = document.createElement("div");
        u.className = "u";
        u.textContent = user;

        const t = document.createElement("div");
        t.className = "t";
        t.textContent = text;

        wrap.appendChild(u);
        wrap.appendChild(t);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function sendChat() {
        const text = (msgInput.value || "").trim();
        if (!text) return;

        // üëá el host se identifica como "Host" (sin tocar backend)
        socket.emit("chat-message", { room, text: `[HOST] ${text}` });

        msgInput.value = "";
        msgInput.focus();
      }

      sendBtn.addEventListener("click", sendChat);
      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendChat();
      });

      socket.on("chat-message", ({ user, text }) => {
        // si el backend siempre manda user:"Usuario", igual lo mostramos
        // y si el host manda "[HOST] ..." lo convertimos bonito:
        if (typeof text === "string" && text.startsWith("[HOST] ")) {
          addMessage({ user: "Host", text: text.replace("[HOST] ", "") });
        } else {
          addMessage({ user: user || "Usuario", text: text || "" });
        }
      });

      // ====== AUDIO MIX ======
      async function initAudioMix() {
        const micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") {
          await audioCtx.resume().catch(() => {});
        }

        micSource = audioCtx.createMediaStreamSource(micStream);
        songSource = audioCtx.createMediaElementSource(songEl);

        destination = audioCtx.createMediaStreamDestination();

        musicGain = audioCtx.createGain();
        musicGain.gain.value = parseFloat(musicVol.value || "0.7");

        micSource.connect(destination);
        songSource.connect(musicGain);
        musicGain.connect(destination);

        // monitoreo local
        micSource.connect(audioCtx.destination);
        musicGain.connect(audioCtx.destination);

        mixedStream = destination.stream;
        musicVol.disabled = false;
      }

      async function startBroadcast() {
        setStatus("Pidiendo permiso de micr√≥fono y preparando mezcla...");
        await initAudioMix();

        socket.emit("join", { room, role: "host" });
        setStatus("Transmitiendo. Elige un MP3, s√∫belo y dale play.");

        pickBtn.disabled = false;
        uploadBtn.disabled = false;
        songBtn.disabled = false;
        stopSongBtn.disabled = false;

        socket.on("peer-joined", async ({ id, role }) => {
          if (role !== "listener") return;

          const pc = new RTCPeerConnection(pcConfig);
          peers.set(id, pc);

          for (const track of mixedStream.getTracks()) {
            pc.addTrack(track, mixedStream);
          }

          pc.onicecandidate = (e) => {
            if (e.candidate) {
              socket.emit("webrtc-ice", { to: id, candidate: e.candidate, room });
            }
          };

          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          socket.emit("webrtc-offer", { to: id, sdp: pc.localDescription, room });
          setStatus(`Oyente conectado: ${id}`);
        });

        socket.on("webrtc-answer", async ({ from, sdp }) => {
          const pc = peers.get(from);
          if (!pc) return;
          await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        });

        socket.on("webrtc-ice", async ({ from, candidate }) => {
          const pc = peers.get(from);
          if (!pc) return;
          try { await pc.addIceCandidate(candidate); } catch {}
        });

        socket.on("peer-left", ({ id }) => {
          const pc = peers.get(id);
          if (pc) pc.close();
          peers.delete(id);
        });

        socket.on("room-stats", ({ total }) => {
          connectedCountEl.textContent = String(total);
        });

        // mensajito al iniciar
        addMessage({ user: "Sistema", text: "Chat listo. Lo que escribas lo ven los oyentes." });
      }

      startBtn.addEventListener("click", () => {
        startBtn.disabled = true;
        startBroadcast().catch((err) => {
          console.error(err);
          setStatus("Error: " + (err.message || err));
          startBtn.disabled = false;
        });
      });

      musicVol.addEventListener("input", () => {
        if (!musicGain) return;
        musicGain.gain.value = parseFloat(musicVol.value);
      });

      pickBtn.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", () => {
        selectedFile = fileInput.files?.[0] ?? null;
        if (selectedFile) setStatus(`MP3 seleccionado: ${selectedFile.name}`);
      });

      uploadBtn.addEventListener("click", async () => {
        if (!selectedFile) { setStatus("Primero elige un MP3."); return; }

        try {
          setStatus("Subiendo MP3 al servidor...");
          uploadBtn.disabled = true;

          const form = new FormData();
          form.append("file", selectedFile);

          const res = await fetch("/api/upload-mp3", { method: "POST", body: form });
          if (!res.ok) throw new Error((await res.text()) || "Upload failed");

          const data = await res.json();
          const mp3Url = data.url;

          songEl.src = mp3Url;
          songEl.load();

          setStatus(`‚úÖ Subido: ${selectedFile.name}. Dale play.`);
        } catch (e) {
          console.error(e);
          setStatus("‚ùå Error subiendo MP3 (¬øes mp3 de verdad?).");
        } finally {
          uploadBtn.disabled = false;
        }
      });

      songBtn.addEventListener("click", async () => {
        try {
          if (!songEl.src) { setStatus("Primero sube un MP3."); return; }
          if (audioCtx && audioCtx.state === "suspended") await audioCtx.resume().catch(() => {});
          await songEl.play();
          setStatus("üéµ Canci√≥n sonando (tambi√©n la oyen los oyentes)");
        } catch (e) {
          console.log(e);
          setStatus("No se pudo reproducir la canci√≥n. Toca otra vez.");
        }
      });

      stopSongBtn.addEventListener("click", () => {
        songEl.pause();
        setStatus("‚è∏ Canci√≥n pausada");
      });
    </script>
  </body>
</html>
